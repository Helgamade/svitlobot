#!/bin/bash
echo "===== Deploying svitlobot.helgamade.com ====="

TARGET="/home/idesig02/helgamade.com/svitlobot"
BARE_REPO="/home/idesig02/deploy-svitlobot.git"

while read oldrev newrev ref
do
    if [[ $ref =~ .*/main$ ]] || [[ $ref =~ .*/master$ ]]; then
        echo "Deploying branch to production..."

        unset GIT_DIR

        if [ ! -d "$TARGET" ]; then
            echo "First deploy: cloning into $TARGET..."
            mkdir -p "$(dirname "$TARGET")"
            git clone "$BARE_REPO" "$TARGET"
            cd "$TARGET" || exit 1
        else
            cd "$TARGET" || exit 1
            if [ ! -d ".git" ]; then
                echo "Not a git repo, initializing..."
                git init
                git remote add origin "$BARE_REPO"
            fi
            git remote set-url origin "$BARE_REPO" 2>/dev/null || true
            git fetch origin master 2>&1 || git fetch origin 2>&1
            git checkout -B master origin/master 2>/dev/null || true
            git reset --hard origin/master 2>&1 || git reset --hard FETCH_HEAD 2>&1
            echo "Removing untracked files (keeping .env and logs)..."
            git clean -fd -e .env -e .env.save -e "*.log" -e "__pycache__" 2>/dev/null || true
            echo "Verify: main.py db.py message_format.py"
            ls -la main.py db.py message_format.py config.py 2>/dev/null || true
        fi

        echo "Restarting svitlobot..."
        /usr/bin/pkill -f "python main.py" 2>/dev/null || true
        sleep 1
        "$TARGET/deploy/start-svitlobot-if-needed.sh" 2>/dev/null || true

        echo "===== Deployment complete! ====="
    else
        echo "Ref $ref received. Not deploying."
    fi
done
