# –ö–∞–∫ —Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç svitlobot

## –¶–µ–ª—å

–û–¥–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ Tuya (Aubess Smart Socket EM, EU) –≤ –∫–∞–Ω–∞–ª–µ ‚Äî –ø–æ –Ω–µ–º—É –≤–∏–¥–Ω–æ, –µ—Å—Ç—å –ª–∏ —Å–≤–µ—Ç. –ü—Ä–∏ —Å–º–µ–Ω–µ ¬´—Å–≤—ñ—Ç–ª–æ —î¬ª / ¬´—Å–≤—ñ—Ç–ª–æ –Ω–µ–º–∞¬ª –≤ Telegram –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –ø–∏—à–µ—Ç—Å—è –≤ MySQL –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏).

---

## –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –∫—Ä—É—Ç—è—Ç—Å—è –¥–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

### 1. –û–ø—Ä–æ—Å–Ω—ã–π –±–æ—Ç (—Ä–µ–∑–µ—Ä–≤ / –¥–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞)

- **–°–∫—Ä–∏–ø—Ç:** `main.py`
- **–û–∫—Ä—É–∂–µ–Ω–∏–µ:** `venv` (Python 3.6)
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** —Ä–∞–∑ –≤ **POLL_INTERVAL** —Å–µ–∫—É–Ω–¥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 300 = 5 –º–∏–Ω) –¥–µ—Ä–≥–∞–µ—Ç Tuya REST API: —Ç–æ–∫–µ–Ω ‚Üí –∏–Ω—Ñ–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (online/offline) ‚Üí —Å—Ç–∞—Ç—É—Å. –ü—Ä–∏ —Å–º–µ–Ω–µ online/offline –ø–∏—à–µ—Ç –≤ MySQL (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω), —Å–æ–±–∏—Ä–∞–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —à–ª—ë—Ç –≤ Telegram.
- **–ö–∞–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:** cron –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç `deploy/start-svitlobot-if-needed.sh`; —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø—Ä–æ—Ü–µ—Å—Å `main.py`, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤ —Ñ–æ–Ω–µ. –õ–æ–≥: `svitlobot.log`.
- **–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:** hook –¥–µ–ª–∞–µ—Ç `pkill -f "python main.py"`, –ø–æ—Ç–æ–º —Å–Ω–æ–≤–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `start-svitlobot-if-needed.sh` ‚Äî –±–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º.

### 2. MQ-–∫–æ–Ω—Å—å—é–º–µ—Ä (–º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)

- **–°–∫—Ä–∏–ø—Ç:** `realtime_consumer.py`
- **–û–∫—Ä—É–∂–µ–Ω–∏–µ:** `venv_mq` (Python 3.8+, —É —Ç–µ–±—è 3.11)
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –¥–µ—Ä–∂–∏—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ **Tuya Pulsar** (EU, `mqe.tuyaeu.com`), –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–æ–ø–∏–∫ `{AccessId}/out/event`. –ö–æ–≥–¥–∞ Tuya —à–ª—ë—Ç —Å–æ–±—ã—Ç–∏–µ **deviceOnline** –∏–ª–∏ **deviceOffline** –ø–æ —Ç–≤–æ–µ–º—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É (`TUYA_DEVICE_ID`), –∫–æ–Ω—Å—å—é–º–µ—Ä —Å—Ä–∞–∑—É: –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–º–µ–Ω—É –≤ MySQL (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω), —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–æ –∂–µ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —à–ª—ë—Ç –≤ Telegram. –ó–∞–¥–µ—Ä–∂–∫–∞ –æ–±—ã—á–Ω–æ 1‚Äì10 —Å–µ–∫—É–Ω–¥ –æ—Ç —Å–æ–±—ã—Ç–∏—è.
- **–ö–∞–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:** cron —Ä–∞–∑ –≤ 2 –º–∏–Ω—É—Ç—ã –≤—ã–∑—ã–≤–∞–µ—Ç `deploy/start-realtime-if-needed.sh`; —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å `realtime_consumer.py`, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤ —Ñ–æ–Ω–µ. –õ–æ–≥: `svitlobot-mq.log`.
- **–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:** –µ—Å–ª–∏ systemd –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ—Ç sudo), hook –≤—ã–∑—ã–≤–∞–µ—Ç `start-realtime-if-needed.sh` ‚Äî –∫–æ–Ω—Å—å—é–º–µ—Ä –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω.

---

## –û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è —Å–æ–±—ã—Ç–∏—è

- **Tuya Cloud:** –≤ –ø—Ä–æ–µ–∫—Ç–µ (Helga, EU) –≤–∫–ª—é—á—ë–Ω **Message Service** (Message Queue, AES-GCM). –í –ø—Ä–∞–≤–∏–ª–∞—Ö –ø–æ–¥–ø–∏—Å–∞–Ω—ã **deviceOnline** –∏ **deviceOffline**. –ü—Ä–∏ —Å–º–µ–Ω–µ –æ–Ω–ª–∞–π–Ω/–æ—Ñ–ª–∞–π–Ω —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ–±–ª–∞–∫–æ –ø—É—à–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Pulsar.
- **–ö–æ–Ω—Å—å—é–º–µ—Ä** –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —Ç–æ–ø–∏–∫ —Å —Ç–≤–æ–∏–º Access ID –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ `devId` = `TUYA_DEVICE_ID`. –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç.

---

## –ß—Ç–æ —É—Ö–æ–¥–∏—Ç –≤ Telegram

–û–±–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç (`message_format.format_short_status`):

- **–°–≤—ñ—Ç–ª–æ —î:** ¬´üü¢ HH:MM –°–≤—ñ—Ç–ª–æ —î¬ª –∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å ¬´–Ω–µ–º–∞¬ª ‚Äî —Å—Ç—Ä–æ–∫–∞ ¬´üïì –ô–æ–≥–æ –Ω–µ –±—É–ª–æ X–≥–æ–¥ Y—Ö–≤¬ª.
- **–°–≤—ñ—Ç–ª–æ –Ω–µ–º–∞:** ¬´üî¥ HH:MM –°–≤—ñ—Ç–ª–æ –Ω–µ–º–∞¬ª –∏ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å ¬´—î¬ª ‚Äî ¬´üïì –í–æ–Ω–æ –±—É–ª–æ X–≥–æ–¥ Y—Ö–≤¬ª.

–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ —Ç–∞–±–ª–∏—Ü–µ MySQL `status_events` (–µ—Å–ª–∏ MySQL –Ω–∞—Å—Ç—Ä–æ–µ–Ω).

---

## MySQL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

- –¢–∞–±–ª–∏—Ü–∞ **status_events**: `device_id`, `changed_at`, `is_online`. –ü–∏—à—É—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–º–µ–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è.
- –ù—É–∂–Ω–∞ –¥–ª—è —Å—Ç—Ä–æ–∫ ¬´–ô–æ–≥–æ –Ω–µ –±—É–ª–æ / –í–æ–Ω–æ –±—É–ª–æ X–≥–æ–¥ Y—Ö–≤¬ª. –ï—Å–ª–∏ MySQL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –≤ Telegram –≤—Å—ë —Ä–∞–≤–Ω–æ —É—Ö–æ–¥—è—Ç ¬´üü¢ –°–≤—ñ—Ç–ª–æ —î¬ª –∏ ¬´üî¥ –°–≤—ñ—Ç–ª–æ –Ω–µ–º–∞¬ª, –Ω–æ –±–µ–∑ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

---

## –î–µ–ø–ª–æ–π

1. –õ–æ–∫–∞–ª—å–Ω–æ: –ø—Ä–∞–≤–∫–∏ –≤ –∫–æ–¥–µ ‚Üí `git add` ‚Üí `git commit` ‚Üí `git push origin master` ‚Üí `git push production master`.
2. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ bare-—Ä–µ–ø–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç **post-receive**: –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–∞–±–æ—á–∞—è –∫–æ–ø–∏—è –≤ `/home/idesig02/helgamade.com/svitlobot` (git fetch + reset --hard, .env –∏ venv/venv_mq –Ω–µ —Ç—Ä–æ–≥–∞—é—Ç—Å—è), —É–±–∏–≤–∞–µ—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å `main.py`, –≤—ã–∑—ã–≤–∞—é—Ç—Å—è `start-svitlobot-if-needed.sh` –∏ (–µ—Å–ª–∏ –Ω–µ—Ç systemd –¥–ª—è MQ) `start-realtime-if-needed.sh`.
3. –í –∏—Ç–æ–≥–µ –æ–ø—Ä–æ—Å–Ω—ã–π –±–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º, MQ-–∫–æ–Ω—Å—å—é–º–µ—Ä –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è.

---

## –ö–æ–Ω—Ñ–∏–≥ (.env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

- **Tuya:** TUYA_ACCESS_ID, TUYA_ACCESS_SECRET, TUYA_DEVICE_ID, TUYA_BASE_URL (EU).
- **Telegram:** TELEGRAM_BOT_TOKEN, TELEGRAM_CHANNEL_ID.
- **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:** POLL_INTERVAL, MQ_MODE (prod/test), MYSQL_*.

---

## –ö—Ä–∞—Ç–∫–æ —Å—Ö–µ–º–∞

```
–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ Tuya (—Å–≤–µ—Ç –≤–∫–ª/–≤—ã–∫–ª, —Å–µ—Ç—å –ø—Ä–æ–ø–∞–ª–∞/–ø–æ—è–≤–∏–ª–∞—Å—å)
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ Tuya Cloud (REST) ‚óÑ‚îÄ‚îÄ main.py –∫–∞–∂–¥—ã–µ POLL_INTERVAL —Å–µ–∫
    ‚îÇ                              ‚îÇ
    ‚îî‚îÄ‚ñ∫ Tuya Pulsar (MQ)   ‚óÑ‚îÄ‚îÄ realtime_consumer.py (–ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Å–ª—É—à–∞–µ—Ç)
                                    ‚îÇ
                                    ‚ñº
                         –°–º–µ–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è? ‚Üí MySQL (–µ—Å–ª–∏ –µ—Å—Ç—å) + Telegram
```

–û–±–∞ –ø—É—Ç–∏ –≤ –∏—Ç–æ–≥–µ —à–ª—é—Ç –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª; MQ –¥–∞—ë—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ —Å–µ–∫—É–Ω–¥—ã, –æ–ø—Ä–æ—Å ‚Äî —Ä–µ–∑–µ—Ä–≤ –∏ –¥–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.
