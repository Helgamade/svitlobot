# –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ (5‚Äì10 —Å–µ–∫)

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

- **realtime_consumer.py** ‚Äî –∫–æ–Ω—Å—å—é–º–µ—Ä Tuya Pulsar (EU), –ø—Ä–∏ `deviceOffline` / `deviceOnline` —Å—Ä–∞–∑—É —à–ª—ë—Ç –≤ Telegram –∏ –ø–∏—à–µ—Ç –≤ MySQL. –¢—Ä–µ–±—É–µ—Ç **Python 3.8+** –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ `requirements-mq.txt`.
- **tuya_mq/** ‚Äî auth –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–Ω–∞ –±–∞–∑–µ tuya-pulsar-sdk-python).

–ó–∞–ø—É—Å–∫: –≤–∫–ª—é—á–∏ Message Service –≤ Tuya IoT (EU), –ø–æ–¥–ø–∏—Å–∫–∞ `{AccessId}-sub`. –õ–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: `python realtime_consumer.py` (–∏–∑ venv —Å `pip install -r requirements.txt -r requirements-mq.txt`). –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å Python 3.9: –æ—Ç–¥–µ–ª—å–Ω—ã–π venv `venv_mq`, systemd `deploy/svitlobot-mq.service`.

---

## –¶–µ–ª—å

–ü–æ–ª—É—á–∞—Ç—å –≤ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–ø–∞–∂–µ/–ø–æ—è–≤–ª–µ–Ω–∏–∏ —Å–≤–µ—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ **5‚Äì10 —Å–µ–∫—É–Ω–¥**, –∞ –Ω–µ —Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç (–æ–ø—Ä–æ—Å).

---

## –í–∞—Ä–∏–∞–Ω—Ç 1: Message Queue (Pulsar) ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π

Tuya —É–º–µ–µ—Ç **–ø—É—à–∏—Ç—å** —Å–æ–±—ã—Ç–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —á–µ—Ä–µ–∑ Message Queue (Pulsar). –ö–∞–∫ —Ç–æ–ª—å–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç—á–∏—Ç–∞–ª–æ—Å—å (DP) –∏–ª–∏ —É—à–ª–æ online/offline, —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ —Ç–≤–æ–π –∫–æ–Ω—Å—å—é–º–µ—Ä –∑–∞ —Å–µ–∫—É–Ω–¥—ã.

### –ß—Ç–æ –¥–∞—ë—Ç

- **deviceOffline** ‚Äî —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø—Ä–æ–ø–∞–ª–æ –∏–∑ —Å–µ—Ç–∏ (—Å–≤–µ—Ç –ø—Ä–æ–ø–∞–ª / —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤—ã–∫–ª—é—á–∏–ª–æ—Å—å) ‚Üí –ø—É—à–∏—Ç—Å—è —Å—Ä–∞–∑—É.
- **deviceOnline** ‚Äî —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å–Ω–æ–≤–∞ –≤ —Å–µ—Ç–∏.
- **devicePropertyMessage** (protocol 1000) ‚Äî –æ—Ç—á—ë—Ç –ø–æ —Å–≤–æ–π—Å—Ç–≤–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä `switch_1`, `relay_status`): –º–æ–∂–Ω–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–º–µ–Ω—É ¬´—Å–≤–µ—Ç –µ—Å—Ç—å/–Ω–µ—Ç¬ª –ø–æ DP, –µ—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É—Å–ø–µ–≤–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç –¥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è.

–ó–∞–¥–µ—Ä–∂–∫–∞ –æ–±—ã—á–Ω–æ **1‚Äì5 —Å–µ–∫—É–Ω–¥** –æ—Ç —Å–æ–±—ã—Ç–∏—è –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ–¥–µ.

### –®–∞–≥–∏

1. **–í–∫–ª—é—á–∏—Ç—å Message Service –≤ –ø—Ä–æ–µ–∫—Ç–µ Tuya**
   - [Tuya IoT Platform](https://eu.platform.tuya.com/) ‚Üí —Ç–≤–æ–π –ø—Ä–æ–µ–∫—Ç (Helga) ‚Üí –≤–∫–ª–∞–¥–∫–∞ **Message Service**.
   - –í–∫–ª—é—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ (–∫–∞–∫–∏–µ `bizCode` –ø—É—à–∏—Ç—å). –î–ª—è –Ω–∞—à–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –Ω—É–∂–Ω—ã –º–∏–Ω–∏–º—É–º: **deviceOnline**, **deviceOffline** –∏ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ **devicePropertyMessage** (–¥–ª—è —Å–º–µ–Ω—ã —Ä–µ–ª–µ/—Å–≤–µ—Ç–∞ –ø–æ DP).

2. **–ü–æ–¥–ø–∏—Å–∫–∞ (subscription)**
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –≤–∏–¥–∞ `{AccessId}-sub`. –ï—ë –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å Pulsar SDK.

3. **–ö–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**
   - –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Pulsar (EU: `pulsar+ssl://mqe.tuyaeu.com:7285/`), —Ç–µ –∂–µ Access ID / Access Secret.
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å [tuya-pulsar-sdk-python](https://github.com/tuya/tuya-pulsar-sdk-python): –∫–æ–Ω—Å—å—é–º–µ—Ä –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Ç–æ–ø–∏–∫ –ø—Ä–æ–µ–∫—Ç–∞, –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç (AES, –ø–æ–¥–ø–∏—Å—å ‚Äî –≤ SDK –µ—Å—Ç—å).
   - –í –∫–æ–Ω—Å—å—é–º–µ—Ä–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ `devId` = —Ç–≤–æ–π `bf92f3b7c6d6f2b30cpsuc`.
   - –ü—Ä–∏ `bizCode` **deviceOffline** ‚Üí —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram: ¬´üî¥ –°–≤—ñ—Ç–ª–æ –Ω–µ–º–∞¬ª (–∏ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∞—Ç—å –≤ MySQL).
   - –ü—Ä–∏ **deviceOnline** ‚Üí ¬´üü¢ –°–≤—ñ—Ç–ª–æ —î¬ª.
   - –ü—Ä–∏ **devicePropertyMessage** ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–º–æ—Ç—Ä–µ—Ç—å `relay_status` / `switch_1` –∏ –ø—Ä–∏ —Å–º–µ–Ω–µ ¬´power_off¬ª –∏–ª–∏ `false` —Ç–æ–∂–µ —Å–ª–∞—Ç—å ¬´–°–≤—ñ—Ç–ª–æ –Ω–µ–º–∞¬ª.

4. **–ó–∞–ø—É—Å–∫**
   - –û—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å (–∏–ª–∏ –ø–æ—Ç–æ–∫) –≤ —Ç–æ–º –∂–µ venv: –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∫—Ä—É—Ç–∏—Ç—Å—è –∫–æ–Ω—Å—å—é–º–µ—Ä Pulsar –∏ –ø–æ —Å–æ–±—ã—Ç–∏—è–º —à–ª—ë—Ç –≤ Telegram. –¢–µ–∫—É—â–∏–π –æ–ø—Ä–æ—Å (—Ä–∞–∑ –≤ 5 –º–∏–Ω) –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤ –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å.

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- **Python:** –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π [tuya-pulsar-sdk-python](https://github.com/tuya/tuya-pulsar-sdk-python) –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ **Python 3.8‚Äì3.12**. –¢–µ–∫—É—â–∏–π –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Äî Python 3.6. –í–∞—Ä–∏–∞–Ω—Ç—ã:
  - –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–æ–Ω—Å—å—é–º–µ—Ä MQ –≤ **–æ—Ç–¥–µ–ª—å–Ω–æ–º venv —Å Python 3.9+** (–µ—Å–ª–∏ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ –µ—Å—Ç—å python3.9) –∏ —Å–ª–∞—Ç—å –≤ Telegram –∏–∑ —Ç–æ–≥–æ –∂–µ —Å–∫—Ä–∏–ø—Ç–∞.
  - –õ–∏–±–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Å—å—é–º–µ—Ä –≤—Ä—É—á–Ω—É—é –ø–æ–¥ 3.6: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Pulsar –ø–æ TLS (–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `pulsar-client` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è 3.6), —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–æ [Data Signature and Decryption](https://developer.tuya.com/en/docs/iot/sign?id=Kavqdhsoc03yr).
- Message Service –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä –ø–æ–¥–ø–∏—Å–∫–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ä–µ–≥–∏–æ–Ω–æ–º (Central Europe ‚Üí EU URL).

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–∫–µ–ª–µ—Ç –∫–æ–Ω—Å—å—é–º–µ—Ä–∞ (–ø–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è Message Service)

- –¢–æ–ø–∏–∫: `{AccessId}/out/event` (prod) –∏–ª–∏ `{AccessId}/out/event-test` (test). –ü–æ–¥–ø–∏—Å–∫–∞: `{AccessId}-sub`.
- URL EU: `pulsar+ssl://mqe.tuyaeu.com:7285/`.
- –í —Ü–∏–∫–ª–µ: `consumer.receive()` ‚Üí —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ `message_util.decrypt_message(pulsar_message, ACCESS_KEY)` ‚Üí –ø–∞—Ä—Å–∏—Ç—å JSON. –í `data` –ø–æ—Å–ª–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏: `bizCode` (`deviceOffline` / `deviceOnline` / `devicePropertyMessage`), `bizData.devId`, –ø—Ä–∏ 1000 ‚Äî `bizData.properties` (code/value).
- –§–∏–ª—å—Ç—Ä –ø–æ `devId` = —Ç–≤–æ–π device_id. –ü—Ä–∏ `deviceOffline` ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram ¬´üî¥ –°–≤—ñ—Ç–ª–æ –Ω–µ–º–∞¬ª, –∑–∞–ø–∏—Å–∞—Ç—å –≤ MySQL; –ø—Ä–∏ `deviceOnline` ‚Üí ¬´üü¢ –°–≤—ñ—Ç–ª–æ —î¬ª; –ø—Ä–∏ `devicePropertyMessage` ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø–æ –∫–æ–¥—É —Å–≤–æ–π—Å—Ç–≤–∞ (—Ä–µ–ª–µ/—Å–≤—ñ—Ç–ª–æ) —Å–ª–∞—Ç—å —Ç–æ –∂–µ.
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: `pulsar-client`, `pycryptodome` (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º `requirements-mq.txt` –¥–ª—è venv —Å Python 3.9+).

---

## –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–∞—Å—Ç—ã–π –æ–ø—Ä–æ—Å (–∫–∞–∂–¥—ã–µ 10‚Äì15 —Å–µ–∫)

–ë–µ–∑ Message Queue: —É–º–µ–Ω—å—à–∏—Ç—å `POLL_INTERVAL` –¥–æ 10‚Äì15 —Å–µ–∫—É–Ω–¥ –∏ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å REST API (device info + status).

### –ü–ª—é—Å—ã

- –ù–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è—Ç—å –≤ Tuya Platform, —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥ –∏ –∫–æ–¥ –æ–ø—Ä–æ—Å–∞.

### –ú–∏–Ω—É—Å—ã

- –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–æ 10‚Äì15 —Å–µ–∫ (–∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞).
- –õ–∏–º–∏—Ç—ã Tuya –Ω–∞ —á–∏—Å–ª–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É ‚Äî –Ω—É–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å [Limits on API Request Frequency](https://developer.tuya.com/en/docs/iot/frequency-control?id=Kcojz2r2dg1f6). –ü—Ä–∏ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ–º –æ–ø—Ä–æ—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã –æ—Ç–∫–∞–∑—ã.
- –ë–æ–ª—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ API –∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

–ï—Å–ª–∏ –ª–∏–º–∏—Ç—ã –ø–æ–∑–≤–æ–ª—è—é—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 –∑–∞–ø—Ä–æ—Å —Ä–∞–∑ –≤ 10 —Å–µ–∫ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ), –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç, –ø–æ–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω MQ.

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

- **–¶–µ–ª—å 5‚Äì10 —Å–µ–∫** ‚Äî –ª—É—á—à–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **–í–∞—Ä–∏–∞–Ω—Ç 1 (Message Queue)**.
- –í –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ: –≤–∫–ª—é—á–∏—Ç—å Message Service, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∏ —Ä–µ–≥–∏–æ–Ω (EU).
- –í –∫–æ–¥–µ: –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å—å—é–º–µ—Ä Pulsar (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∏–ª–∏ –ø–æ—Ç–æ–∫), —Ñ–∏–ª—å—Ç—Ä –ø–æ `device_id`, –ø—Ä–∏ `deviceOffline` / `deviceOnline` (–∏ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ DP) ‚Äî —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Å–ª–∞—Ç—å –≤ Telegram (+ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–∏—Å–∞—Ç—å –≤ MySQL –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏).

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –º–æ–≥—É –¥–∞–ª—å—à–µ —Ä–∞—Å–ø–∏—Å–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ –ø–æ–¥ —Ç–≤–æ–π –ø—Ä–æ–µ–∫—Ç (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫—Ä–∏–ø—Ç–∞, –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Å—å—é–º–µ—Ä–∞ –ø–æ–¥ Python 3.6 –∏–ª–∏ –ø–æ–¥ –æ—Ç–¥–µ–ª—å–Ω—ã–π venv —Å Python 3.9+).
